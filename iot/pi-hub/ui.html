<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Witching Hour Hub</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0b12;
      --panel: #11111a;
      --accent: #d1b15a;
      --muted: #7c7a85;
    }
    body {
      margin: 0;
      font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
      background: radial-gradient(circle at top, #1a1026 0%, #0b0b12 55%);
      color: #efe7dc;
    }
    header {
      padding: 24px;
      border-bottom: 1px solid #262635;
    }
    h1 {
      margin: 0 0 6px 0;
      font-size: 22px;
    }
    main {
      padding: 24px;
      display: grid;
      gap: 18px;
      max-width: 920px;
      margin: 0 auto;
    }
    .panel {
      background: var(--panel);
      border: 1px solid #2a2a38;
      border-radius: 14px;
      padding: 16px;
      display: grid;
      gap: 12px;
    }
    label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    input, select {
      background: #0d0d15;
      border: 1px solid #333344;
      color: #efe7dc;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
    }
    button {
      background: var(--accent);
      color: #15131a;
      border: none;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
    }
    .row {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Witching Hour Pi Hub</h1>
    <div class="muted">Control ESP32 rooms from the browser.</div>
  </header>
  <main>
    <section class="panel">
      <label for="device">Device</label>
      <select id="device"></select>
      <button onclick="refreshDevices()">Refresh Devices</button>
    </section>

    <section class="panel">
      <label>Lighting</label>
      <div class="row">
        <select id="lightOn">
          <option value="1">On</option>
          <option value="0">Off</option>
        </select>
        <input id="brightness" type="number" min="0" max="255" value="120" />
        <input id="r" type="number" min="0" max="255" value="120" />
        <input id="g" type="number" min="0" max="255" value="40" />
        <input id="b" type="number" min="0" max="255" value="10" />
      </div>
      <button onclick="sendLight()">Send Light</button>
    </section>

    <section class="panel">
      <label>Scene</label>
      <div class="row">
        <input id="scene" type="text" value="gallery" />
      </div>
      <button onclick="sendScene()">Send Scene</button>
    </section>

    <section class="panel">
      <label>Audio Title</label>
      <div class="row">
        <input id="audio" type="text" value="Witching Hour Session 01" />
      </div>
      <button onclick="sendAudio()">Send Audio</button>
    </section>

    <section class="panel">
      <label>BLE Scan</label>
      <div class="muted">Requires `pip install bleak` on the Pi.</div>
      <button onclick="bleScan()">Scan BLE</button>
      <pre id="bleResults" class="muted"></pre>
    </section>
  </main>

  <script>
    async function refreshDevices() {
      const res = await fetch('/devices');
      const data = await res.json();
      const select = document.getElementById('device');
      select.innerHTML = '';
      data.devices.forEach((device) => {
        const option = document.createElement('option');
        option.value = device.id;
        option.textContent = `${device.name} (${device.ip})`;
        select.appendChild(option);
      });
    }

    function currentDevice() {
      const select = document.getElementById('device');
      return select.value;
    }

    async function sendLight() {
      const params = new URLSearchParams({
        device: currentDevice(),
        on: document.getElementById('lightOn').value,
        brightness: document.getElementById('brightness').value,
        r: document.getElementById('r').value,
        g: document.getElementById('g').value,
        b: document.getElementById('b').value
      });
      await fetch(`/light?${params.toString()}`, { method: 'POST' });
    }

    async function sendScene() {
      const params = new URLSearchParams({
        device: currentDevice(),
        name: document.getElementById('scene').value
      });
      await fetch(`/scene?${params.toString()}`, { method: 'POST' });
    }

    async function sendAudio() {
      const params = new URLSearchParams({
        device: currentDevice(),
        title: document.getElementById('audio').value
      });
      await fetch(`/audio?${params.toString()}`, { method: 'POST' });
    }

    async function bleScan() {
      const res = await fetch('/ble/scan');
      const data = await res.json();
      document.getElementById('bleResults').textContent = JSON.stringify(data, null, 2);
    }

    refreshDevices();
  </script>
</body>
</html>
